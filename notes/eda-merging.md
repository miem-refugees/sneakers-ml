# Data preprocessing, merging and eda

## Данные и предобработка

- Всё происходит в файле [merger.py](/sneakers_ml/data/merger.py)
- Для каждого датасета дропаем ненужные и лишние колонки
- Приводим все колонки к нижнему регистру
- Дропаем дубликаты в каждом датасете
- Добавляем в каждый датасет колонку с названием сайта

> Всего спарсили 5 сайтов, но пока решили смерджить только 2 из-за сложности с очисткой данных.
> Используем `superkicks` и `sneakerbaas`.

### price and pricecurrency

- Если есть колонка `price` и `pricecurreny` - очищаем и приводим `price` к float.

### title and brand

- В датасетах название `title` кроссовок идёт в формате: `{бренд} {модель} "{цвет}"`,
  поэтому можно разделить модель и цвет по кавычкам.
- Чтобы хорошо смерджилоcь, нужно также убрать бренд из начала `title`, так как в некоторых датасетах бренда в начале нет.
- Для этого берём все колонки `brand` из всех датасетов, создаем список всех брендов, а также их комбинаций по 2.
  Комбинации по два нужны, чтобы получить все возможные коллабы. Какие-то бренды прописываем вручную.
- Далее создали файлик `color_words.txt` (`/data/merged/other/color_words.txt`) и поместили туда основные слова-цвета на английском.
- Наконец можно очистить колонку `title` - сначала удаляются лишние символы, греческие буквы и тд., всё приводится к нижнему регистру.
- Далее слева удаляем бренд (детектим по брендам и коллабам, которые собрали), справа удаляем цвета.
- Цвета из кавычек `"` переносятся в отдельную колонку `color`. Если кавычек нет, то пытаемся просто удалить справа слова из `color_words.txt`
- Колонку `brand` просто чистим от лишних символов

## Merge

- Мерджить будем по очищенной колонке `title`.
- Делаем `groupby` по этой `title` и получаем `main_dataset` (`/data/merged/metadata/main_dataset.csv`), в котором оставили основные колонки.
- Во время `groupby` делаем небольшую обработку брендов, **например, бренды `adidas` и `adidas originals` объединяем в один бренд `adidas`.**
- Получили основной датасет (`main_dataset.csv`). Описание колонок
  - **title_merge** - название модели
  - **brand_merge** - название бренда
  - **images_path** - список путей до спаршенных картинок
  - **price** - цена
  - **pricecurrency** - валюта
  - **color** - список цветов
  - **website** - список названий сайтов

> По итогу 2067 моделей кроссовок смерджились в 877

![image](https://github.com/miem-refugees/sneakers-ml/assets/57370975/215fd546-21b1-492a-8bb9-6f759c466b69)

## Images merge

- Нужно теперь смерджить картинки (раскидать по соответствующим папкам), чтобы было удобно использовать в моделях.
- Мерджить будем двумя способами: по названию бренда и названию модели.

### Обработка картинок во время мерджа

- Картинки одного бренда/модели копируются в одну папку, идентичные файлы удаляются
- Картинки с расширением `.gif` удаляются
- Картинки с остальными расширениями переводятся в палитру `RGB`. (Из-за того что некоторые картинки имеют отдельный канал прозрачности `RGBA`)
- Картинки переводятся к одному формату `.jpeg`

### Brand merge

- Используем полученный ранее `main_dataset.csv`
- Сделаем `groupby` по брендам и начинаем мердж картинок из `images_path`.
- Итоговый датасет по брендам `data/merged/metadata/brands_dataset.csv`. Описание колонок:
  - **brand_merge** - название бренда
  - **unique_images_count** - количество картинок для бренда
  - **images** - путь к папке со смердженными картинками

> Всего 30 брендов
>
> Наблюдается большой дисбаланс по количеству картинок в разных брендах

![image](https://github.com/miem-refugees/sneakers-ml/assets/57370975/4afdad96-b861-4723-88b9-6ccfaa796e96)

### Model merge

- Используем полученный `main_dataset.csv`
- Идем по моделям и мерджим
- Итоговый датасет по моделям `data/merged/metadata/models_dataset.csv`. Описание колонок:
  - **title_merge** - название модели
  - **brand_merge** - название бренда
  - **unique_images_count** - количество картинок для модели
  - **images** - путь к папке со смердженными картинками

![image](https://github.com/miem-refugees/sneakers-ml/assets/57370975/351c8d21-1fca-4f49-9d01-4acb94f460e2)

## EDA

- Сделали небольшое EDA [`basic-eda.ipynb`](/notebooks/eda/basic-eda.ipynb)
  - Вывели как выглядят метаданные
  - Посмотрели сколько картинок всего
  - Посмотрели какие бренды и модели имеют больше всего картинок
  - Посмотрели, что все картинки в одном формате и в одной `RGB` палитре, значит имеют по 3 канала. (значит всё правильно преобразовали)
  - Посмотрели размеры картинок - они различные, от 400х400 до 2000х2000.
- Пока работаем с датасетом с брендами. Взяли эмбеддинги [`resnet-embedding-eda.ipynb`](/notebooks/eda/resnet-embedding-eda.ipynb)
  всех картинок c помощью [`resnet152`](/sneakers_ml/data/features/resnet152.py) и использовали SVD, PCA, TSNE. Посмотрели как картинки лежат в пространстве.
- В TSNE нём видны кластеры, но они скорее всего соответствуют не брендам, а **ракурсам** изображений.
  ![image](https://github.com/miem-refugees/sneakers-ml/assets/57370975/cbf23bf5-956a-4a1c-b144-f0179e1d1c4d)
- Самый показательный это **UMAP**. В нём отчетливо видны кластеры. ![image](https://github.com/miem-refugees/sneakers-ml/assets/57370975/2384b5df-e859-4afd-a41b-a756966404cf)
- Визулизовав их стало ясно, что они соответствуют ракурсам изображения. Например, в левом кластере были только изображения подошв. ![image](https://github.com/miem-refugees/sneakers-ml/assets/57370975/104192a7-2960-4702-9aad-42afde66b137)
- Также попробовали считать косинусную близость между картинками, чтобы найти дубликаты и удалить. Сработало не очень. Даже при большом
  пороге картинки отличаются.
- Например, **порог 0.99**:

| Image 1                                                                                                     | Image 2                                                                                                     | Image 3                                                                                                     |
| ----------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------- |
| ![image](https://github.com/miem-refugees/sneakers-ml/assets/57370975/729fff40-880f-4538-a889-4d3ff8e0566a) | ![image](https://github.com/miem-refugees/sneakers-ml/assets/57370975/291574af-a2e0-4b1b-8f53-ee4c79a9e44c) | ![image](https://github.com/miem-refugees/sneakers-ml/assets/57370975/ca52d8c6-dbcb-4206-9c92-9064da07644f) |
